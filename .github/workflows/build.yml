name: Build and Release chan_moq.so

on:
  push:
    branches:
      - main
      - master
      - develop
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - master
      - develop
  workflow_dispatch:

jobs:
  build:
    name: Build chan_moq.so
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        ubuntu-version: ['20.04', '22.04']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libwebsockets-dev \
            libjson-c-dev \
            wget \
            tar
          
          # Install Asterisk development headers
          echo "Installing Asterisk development headers..."
          
          # Try to install from package manager first
          if sudo apt-cache search asterisk-dev | grep -q "^asterisk-dev "; then
            echo "Installing asterisk-dev from apt..."
            sudo apt-get install -y asterisk-dev
          else
            # If not available, download and install headers manually
            echo "Asterisk-dev not available in package manager, installing headers manually..."
            ASTERISK_VERSION="20.10.0"
            cd /tmp
            
            # Try downloading with better error handling
            if ! wget --timeout=30 --tries=3 https://downloads.asterisk.org/pub/telephony/asterisk/asterisk-${ASTERISK_VERSION}.tar.gz; then
              echo "Failed to download Asterisk ${ASTERISK_VERSION}, trying 20.9.0..."
              ASTERISK_VERSION="20.9.0"
              wget --timeout=30 --tries=3 https://downloads.asterisk.org/pub/telephony/asterisk/asterisk-${ASTERISK_VERSION}.tar.gz
            fi
            
            tar -xzf asterisk-${ASTERISK_VERSION}.tar.gz
            cd asterisk-${ASTERISK_VERSION}
            sudo mkdir -p /usr/include/asterisk
            sudo cp -r include/asterisk/* /usr/include/asterisk/
            echo "Successfully installed Asterisk headers from version ${ASTERISK_VERSION}"
          fi
      
      - name: Build chan_moq.so
        run: |
          make clean || true
          make
          ls -lh chan_moq.so
          
          # Verify the build
          file chan_moq.so
          ldd chan_moq.so || true
      
      - name: Run tests
        run: |
          # Check dependencies
          make check-deps || true
          
          # Run test target if dependencies are met
          if [ -f chan_moq.so ]; then
            make test || true
          fi
      
      - name: Prepare artifact
        run: |
          mkdir -p dist
          cp chan_moq.so dist/
          cp moq.conf dist/
          cp README.md dist/
          cp INSTALL.md dist/ || true
          
          # Create a version file
          echo "Build Date: $(date -u)" > dist/BUILD_INFO.txt
          echo "Ubuntu Version: ${{ matrix.ubuntu-version }}" >> dist/BUILD_INFO.txt
          echo "Git Commit: ${GITHUB_SHA}" >> dist/BUILD_INFO.txt
          echo "Git Ref: ${GITHUB_REF}" >> dist/BUILD_INFO.txt
          
          # Create tarball
          cd dist
          tar -czf ../chan_moq-ubuntu${{ matrix.ubuntu-version }}.tar.gz *
          cd ..
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: chan_moq-ubuntu${{ matrix.ubuntu-version }}
          path: |
            chan_moq-ubuntu${{ matrix.ubuntu-version }}.tar.gz
            dist/chan_moq.so
          retention-days: 30
      
      - name: Upload build info
        uses: actions/upload-artifact@v4
        with:
          name: build-info-ubuntu${{ matrix.ubuntu-version }}
          path: dist/BUILD_INFO.txt
          retention-days: 30

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Display structure of downloaded files
        run: ls -R artifacts
      
      - name: Create Release Notes
        id: release_notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          ## MoQ Channel Driver Release
          
          ### Installation
          
          1. Download the appropriate `.tar.gz` file for your Ubuntu version
          2. Extract: `tar -xzf chan_moq-ubuntu*.tar.gz`
          3. Install: `sudo cp chan_moq.so /usr/lib/asterisk/modules/`
          4. Configure: `sudo cp moq.conf /etc/asterisk/`
          5. Load module: `sudo asterisk -rx "module load chan_moq.so"`
          
          ### Files Included
          
          - `chan_moq.so` - The compiled Asterisk channel driver
          - `moq.conf` - Configuration file
          - `README.md` - Documentation
          - `BUILD_INFO.txt` - Build information
          
          ### Supported Platforms
          
          - Ubuntu 20.04 LTS
          - Ubuntu 22.04 LTS
          
          ### Dependencies
          
          - Asterisk (with development headers)
          - libwebsockets
          - libjson-c
          - pthread
          
          See README.md for full installation and usage instructions.
          EOF
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/chan_moq-ubuntu20.04/*.tar.gz
            artifacts/chan_moq-ubuntu22.04/*.tar.gz
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload individual .so files to release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/chan_moq-ubuntu20.04/chan_moq.so
            artifacts/chan_moq-ubuntu22.04/chan_moq.so
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  verify:
    name: Verify Build
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: Download Ubuntu 22.04 artifact
        uses: actions/download-artifact@v4
        with:
          name: chan_moq-ubuntu22.04
      
      - name: Verify artifact
        run: |
          echo "Verifying downloaded artifacts..."
          ls -lh
          
          if [ -f "chan_moq.so" ]; then
            echo "✓ chan_moq.so found"
            file chan_moq.so
            size=$(stat -f%z chan_moq.so 2>/dev/null || stat -c%s chan_moq.so)
            echo "Size: $size bytes"
            
            if [ $size -gt 10000 ]; then
              echo "✓ File size looks reasonable"
            else
              echo "✗ File seems too small"
              exit 1
            fi
          else
            echo "✗ chan_moq.so not found"
            exit 1
          fi
          
          if [ -f "chan_moq-ubuntu22.04.tar.gz" ]; then
            echo "✓ Tarball found"
            tar -tzf chan_moq-ubuntu22.04.tar.gz
          fi
